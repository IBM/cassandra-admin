{% layout="layout.html" %}
<div x-data="main()">
    {(components/toast.html)}

    <template x-if="schemaError">
      {(components/interstitial.html, { icon="bi-exclamation-triangle-fill", text="Could not fetch Cassandra schema. Please check your connection settings." })}
    </template>
    <div class="row g-0 d-none" x-show="!schemaError" :class="{ 'd-flex': !schemaError, 'd-none': schemaError }" style="height: 100vh;">
      <nav class="col-lg-2 col-md-3 d-md-block h-100 overflow-auto sidebar position-relative border-end vh-100">
        <div class="p-3 bg-body-tertiary border-bottom position-sticky top-0 z-2 mb-0 d-flex justify-content-between align-items-center">
          <a href="/" @click.prevent="goHome()" class="text-decoration-none text-body-emphasis">{{ config.app_name }}</a>
          <div>
            <button x-data 
              @click="darkMode = darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'light' : 'dark'" 
              class="btn btn-link btn-sm float-end text-body-emphasis" 
              :title="darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
              <i class="bi" :class="darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'bi-sun-fill' : 'bi-moon-fill'"></i>
            </button>
            {% if os.getenv("CA_DEBUG_MODE") == "true" and constants.feature_flags.enable_htmx then %}
            <a href="/settings" 
              class="btn btn-link btn-sm float-end text-body-emphasis" 
              title="Settings">
              <i class="bi bi-gear"></i>
            </a>
            {% end %}
          </div>
        </div>
        <div x-show="loading" class="text-center position-absolute start-50 top-50 translate-middle">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <span class="ms-2">Loading schema...</span>
        </div>

        <div class="text-nowrap" x-show="!loading">
          <template x-for="ks in schema" :key="ks.keyspace">
              <div class="px-3 border-bottom border-light-subtle" 
                  :class="{ 'bg-body-secondary': selected.keyspace === ks.keyspace }"
                  x-data="{ showKeyspaceActions: false, keyspaceDropdownOpen: false }"
                  @mouseenter="showKeyspaceActions = true"
                  @mouseleave="if (!keyspaceDropdownOpen) showKeyspaceActions = false">
                <div class="d-flex align-items-center">
                  <button class="d-flex flex-fill btn btn-sm text-start w-100 border-0" 
                          data-bs-toggle="collapse"
                          :data-bs-target="'#collapse-' + ks.keyspace"
                          :class="{ 'fw-bold text-body-emphasis': selected.keyspace === ks.keyspace }"
                          :aria-expanded="selected.keyspace === ks.keyspace ? 'true' : 'false'">
                    <i class="bi bi-database-fill pe-1"></i>
                    <span class="text-truncate" x-text="ks.keyspace" :title="ks.keyspace"></span>
                  </button>

                  <div class="dropdown ms-auto" style="flex-shrink: 0;" x-show="showKeyspaceActions || (selected.keyspace === ks.keyspace)" x-cloak>
                    <a href="#" class="text-decoration-none text-center px-2" style="width: 30px; color: inherit;"  data-bs-toggle="dropdown" aria-expanded="false" @click.prevent="keyspaceDropdownOpen = true" @click.outside="keyspaceDropdownOpen = false; showKeyspaceActions = false">
                      <i class="bi bi-three-dots"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm py-1">
                      <li>
                        <a class="dropdown-item small text-danger" href="javascript:void(0)" @click.prevent="dropKeyspace(ks.keyspace)">
                          <i class="bi bi-trash me-2"></i>Drop Keyspace
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              <ul class="list-unstyled collapse mb-1" :id="'collapse-' + ks.keyspace"
                :class="{ 'show': selected.keyspace === ks.keyspace }">
                <template x-for="entity in ks.entities" :key="entity.type + '-' + entity.name">
                  <li class="nav-item d-flex rounded align-items-center position-relative fw-medium small" 
                  :class="{ 'bg-black text-white ': selected.keyspace === ks.keyspace && selected.entity === entity.name }"
                  x-data="{ showEntityActions: false, entityDropdownOpen: false }"
                  @mouseenter="showEntityActions = true"
                  @mouseleave="if (!entityDropdownOpen) showEntityActions = false"
                  >
                    <a 
                      :href="'/' + entity.type + '/' + ks.keyspace + '/' + entity.name"
                      @click.prevent="loadEntity(ks.keyspace, entity.name, entity.type)"
                      class="d-flex flex-fill ps-4 py-1 text-decoration-none overflow-hidden text-nowrap"
                      style="color: inherit;">
                      <i class="bi pe-1" :class="entity.type === 'table' ? 'bi-table' : entity.type === 'view' ? 'bi-eye' : 'bi-diagram-3'" class="pe-1"></i>
                      <span class="text-truncate" x-text="entity.name" :title="entity.name"></span>
                    </a>
                    
                    <div class="dropdown" style="flex-shrink: 0;" x-show="showEntityActions || (selected.keyspace === ks.keyspace && selected.entity === entity.name)" x-cloak>
                      <a href="javascript:void(0)" class="text-decoration-none text-center px-3" style="width: 30px; color: inherit;" data-bs-toggle="dropdown" aria-expanded="false" @click.prevent="entityDropdownOpen = true" @click.outside="entityDropdownOpen = false; showEntityActions = false"> 
                        <i class="bi bi-three-dots"></i>
                      </a>
                      <ul class="dropdown-menu dropdown-menu-end shadow-sm py-1">
                        <template x-for="action in entityTypes[entity.type].actions" :key="action">
                          <li>
                            <a class="dropdown-item small" 
                               :class="actions[action].isDangerous ? 'text-danger' : ''"
                               href="javascript:void(0)" 
                               @click.prevent="handleEntityAction(entity.type, ks.keyspace, entity.name, action)">
                              <i class="bi me-2" :class="actions[action].icon"></i>
                              <span x-text="actions[action].label"></span>
                            </a>
                          </li>
                        </template>
                      </ul>
                    </div>
                  </li>
                </template>
              </ul>
            </div>
          </template>
        </div>
      </nav>
      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 overflow-auto vh-100 shadow position-relative">
        <div x-show="entityLoading" class="p-5 position-absolute rounded start-50 text-center top-50 translate-middle" style="z-index: 9999;">
          <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
          <span class="ms-2 text-muted small" x-text="selected.entity ? 'Loading ' + selected.entityType + ' ' + selected.entity + '...' : 'Loading...'"></span>
        </div>
        <div x-show="!entityLoading && entityData">
          <template x-if="entityData && entityData.columns && entityData.columns.length > 0">
            <div class="d-flex flex-column small vh-100">
              <div class="table-responsive flex-fill overflow-y-auto">
                <table class="table table-striped table-hover table-bordered text-nowrap" style="margin-left: -1px;">
                  <thead class="text-nowrap" :class="darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'table-dark' : 'table-light'">
                    <tr>
                      <template x-for="col in entityData.columns" :key="col.column_name">
                        <th>
                          <template x-if="col.kind === 'partition_key'">
                            <i class="bi bi-key-fill d-inline-block" title="Partition Key" style="transform: rotate(-225deg);"></i>
                          </template>
                          <template x-if="col.kind === 'clustering'">
                            <i class="bi bi-key d-inline-block" title="Clustering Key" style="transform: rotate(-225deg);"></i>
                          </template>
                          <span x-text="col.column_name"></span>
                          <small class="badge bg-secondary text-white user-select-none ms-1 small" x-text="col.type"></small>
                        </th>
                      </template>
                    </tr>
                  </thead>
                  <tbody class="font-monospace">
                    <template x-if="entityData.rows && entityData.rows.length > 0">
                      <template x-for="(row, idx) in entityData.rows" :key="idx">
                        <tr>
                          <template x-for="col in entityData.columns" :key="col.column_name">
                            <td x-text="row[col.column_name] !== undefined && row[col.column_name] !== null ? row[col.column_name] : ''">
                            </td>
                          </template>
                        </tr>
                      </template>
                    </template>
                  </tbody>
                </table>
              </div>
              <template x-if="!entityData.rows || entityData.rows.length === 0">
                {(components/interstitial.html, { icon="bi-inbox", text="No rows to show" })}
              </template>
              <!-- Pagination Footer -->
              <div class="bottom-0 start-0 bg-body-tertiary w-100 p-2 border-top d-flex flex-shrink-0 justify-content-between align-items-center">
                <div>
                  Showing <span x-text="entityData.rows ? entityData.rows.length : 0"></span> rows
                  <span x-show="pagination.currentPage > 1" x-text="' (Page ' + pagination.currentPage + ')'"></span>
                </div>
                <div class="d-flex gap-2 align-items-center">
                  <select class="form-select form-select-sm" style="width: auto;" x-model="pageSize" @change="changePageSize()">
                    {% for _, size in ipairs(config.page_sizes) do %}
                      <option value="{{ size }}">{{ size }} rows</option>
                    {% end %}
                  </select>
                  <div class="btn-group btn-group-sm bg-body" role="group">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary text-body-emphasis bg-body-tertiary" 
                      @click="previousPage()"
                      :disabled="!canGoPrevious()"
                      :class="{ 'disabled': !canGoPrevious() }">
                      <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary text-body-emphasis bg-body-tertiary" 
                      @click="nextPage()"
                      :disabled="!canGoNext()"
                      :class="{ 'disabled': !canGoNext() }">
                      Next <i class="bi bi-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>

        <template x-if="!entityData && !entityLoading">
          {(components/interstitial.html, { icon="bi-database-fill", text="Select an item from the sidebar" })}
        </template>
      </main>
    </div>



    <!-- Modals -->
    <div class="modal" id="truncate_modal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content small">
          <div class="modal-body">
            <p>Are you sure you want to truncate <strong x-text="modalData.keyspace + '.' + modalData.entity"></strong>?</p>
            <p class="text-danger mb-0">This will permanently delete all data.</p>
          </div>
          <div class="modal-footer p-1">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-sm btn-danger" @click="executeTruncate()">Truncate</button>
          </div>
        </div>
      </div>
    </div>

  <div class="modal" id="drop_entity_modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content small">
        <div class="modal-body">
          <p>Are you sure you want to drop <strong x-text="modalData.keyspace + '.' + modalData.entity"></strong>?</p>
          <p class="text-danger mb-0">This will permanently delete the <span x-text="modalData.entityType"></span> and all its data.</p>
        </div>
        <div class="modal-footer p-1">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-sm btn-danger" @click="executeDropEntity()">Drop <span x-text="modalData.entityType ? modalData.entityType.charAt(0).toUpperCase() + modalData.entityType.slice(1) : ''"></span></button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="export_modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content small">
        <form id="exportForm" method="POST" target="_blank">
          <div class="modal-body">
            <p>Export <span x-text="modalData.entityType ? modalData.entityType : ''"></span> <strong x-text="modalData.keyspace + '.' + modalData.entity"></strong> as:</p>
            <div class="mb-3">
              <label for="exportFormat" class="form-label">Format</label>
              <select id="exportFormat" name="format" class="form-select form-select-sm">
                <template x-for="(fmt, index) in exportFormats[modalData.entityType]" :key="fmt">
                  <option :value="fmt" x-text="fmt.toUpperCase()" :selected="index === 0"></option>
                </template>
              </select>
            </div>
            <div class="mb-3">
              <label for="exportLimit" class="form-label">Row Limit (0 for all)</label>
              <input type="number" id="exportLimit" name="limit" class="form-control form-control-sm" value="0" min="0">
            </div>
            <div class="form-check" x-show="modalData.entityType === 'table'" x-cloak>
              <input class="form-check-input" type="checkbox" value="1" name="include_ddl" id="includeDDL" checked>
              <label class="form-check-label" for="includeDDL">
                Include 'CREATE' statement
              </label>
            </div>
          </div>
          <div class="modal-footer p-1">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-sm btn-primary">Export</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="drop_keyspace_modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content small">
        <div class="modal-body">
          <p>Are you sure you want to drop keyspace <strong x-text="modalData.keyspace"></strong>?</p>
          <p class="text-danger mb-0">This will permanently delete the keyspace and all its tables and data.</p>
        </div>
        <div class="modal-footer p-1">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-sm btn-danger" @click="executeDropKeyspace()">Drop Keyspace</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
function main() {
  return {
    schema: [],
    actions: {
      export: { label: 'Export', icon: 'bi-download', isDangerous: false },
      truncate: { label: 'Truncate', icon: 'bi-scissors', isDangerous: false },
      drop: { label: 'Drop', icon: 'bi-trash', isDangerous: true }
    },

    entityTypes: {
      table: {
        icon: 'bi-table',
        label: 'Table',
        exportFormats: ['cql', 'csv', 'json'],
        actions: ['export', 'truncate', 'drop']
      },
      view: {
        icon: 'bi-eye',
        label: 'View',
        exportFormats: ['csv', 'json'],
        actions: ['export', 'drop']
      }
    },

    entityData: null,
    selected: { keyspace: null, entity: null, entityType: null },
    loading: true,
    entityLoading: false,
    modalData: { keyspace: null, entity: null, entityType: null },
    pageSize: {{ config.default_page_size }},
    schemaError: null,
    format: 'cql',
    toasts: [],
    visibleToasts: [],

    exportFormats: {
      table: ['cql', 'csv', 'json'],
      view: ['csv', 'json']
    },

    pagination: {
      currentPage: 1,
      pagingStates: [],
      hasMorePages: false
    },

    showToast(title, message, type = 'info', duration = 5000) {
      const id = Date.now();
      const toast = { id, title, message, type };
      this.toasts.push(toast);
      this.visibleToasts.push(toast);
      setTimeout(() => this.removeToast(id), duration);
    },

    removeToast(id) {
      const index = this.visibleToasts.findIndex(toast => toast.id === id);
      if (index !== -1) {
        this.visibleToasts.splice(index, 1);
      }
    },

    async fetchResponse(url, options = {}) {
      const response = await fetch(url, options);
      const data = await response.json();
      
      if (data.error) {
        this.showToast('Error', data.message, 'error');
        throw new Error(data.message);
      }
      
      if (data.success && data.message) {
        this.showToast('Success', data.message, 'success');
      }
      
      return data;
    },

    async loadSchema() {
      try {
        this.schema = await this.fetchResponse('/api/schema');
        this.schemaError = null;
      } catch (error) {
        this.schemaError = error.message;
      } finally {
        this.loading = false;
      }
    },

    async loadEntity(keyspace, entity, entityType, resetPagination = true) {
      this.selected = { keyspace, entity, entityType };
      this.entityLoading = true;

      if (resetPagination) {
        this.resetPagination();
      }

      window.history.pushState(
        { keyspace, entity, entityType },
        '',
        `/${entityType}/${keyspace}/${entity}`
      );

      try {
        const currentPagingState = this.getCurrentPagingState();
        const url = new URL(`/api/${entityType}/${keyspace}/${entity}`, window.location.origin);
        url.searchParams.append('page_size', this.pageSize);
        if (currentPagingState) {
          url.searchParams.append('paging_state', currentPagingState);
        }

        const data = await this.fetchResponse(url);
        this.entityData = data;
        this.pagination.hasMorePages = data.has_more_pages || false;
        
        if (data.paging_state && data.has_more_pages) {
          this.storeNextPagingState(data.paging_state);
        }
      } catch (error) {
        console.error('Load entity failed:', error);
      } finally {
        this.entityLoading = false;
      }
    },

    handleEntityAction(entityType, keyspace, entity, actionId) {
      const action = this.actions[actionId];
      if (!action) return;

      this.modalData = { keyspace, entity, entityType };

      if (actionId === 'export') {
        const form = document.getElementById('exportForm');
        form.action = `/api/${entityType}/${keyspace}/${entity}/export`;
        new bootstrap.Modal(document.getElementById('export_modal')).show();
      } else if (actionId === 'truncate') {
        new bootstrap.Modal(document.getElementById('truncate_modal')).show();
      } else if (actionId === 'drop') {
        new bootstrap.Modal(document.getElementById('drop_entity_modal')).show();
      }
    },

    resetPagination() {
      this.pagination = {
        currentPage: 1,
        pagingStates: [],
        hasMorePages: false
      };
    },

    getCurrentPagingState() {
      return this.pagination.currentPage === 1 
        ? null 
        : this.pagination.pagingStates[this.pagination.currentPage - 2] || null;
    },

    storeNextPagingState(pagingState) {
      const index = this.pagination.currentPage - 1;
      if (this.pagination.pagingStates[index] !== pagingState) {
        this.pagination.pagingStates[index] = pagingState;
      }
    },

    canGoPrevious() {
      return this.pagination.currentPage > 1;
    },

    canGoNext() {
      return this.pagination.hasMorePages;
    },

    async previousPage() {
      if (!this.canGoPrevious()) return;
      this.pagination.currentPage--;
      await this.loadEntity(this.selected.keyspace, this.selected.entity, this.selected.entityType, false);
    },

    async nextPage() {
      if (!this.canGoNext()) return;
      this.pagination.currentPage++;
      await this.loadEntity(this.selected.keyspace, this.selected.entity, this.selected.entityType, false);
    },

    async changePageSize() {
      await this.loadEntity(this.selected.keyspace, this.selected.entity, this.selected.entityType, true);
    },

    restoreFromURL() {
      const path = window.location.pathname;
      const match = path.match(/^\/(table|view)\/([^\/]+)\/([^\/]+)$/);
      
      if (match) {
        const [, entityType, keyspace, entity] = match;
        this.loadEntity(keyspace, entity, entityType);
      }
    },

    async executeTruncate() {
      const { keyspace, entity, entityType } = this.modalData;
      bootstrap.Modal.getInstance(document.getElementById('truncate_modal')).hide();

      try {
        await this.fetchResponse(`/api/${entityType}/${keyspace}/${entity}/truncate`, { method: 'POST' });
        await this.loadEntity(keyspace, entity, entityType);
      } catch (error) {
        console.error('Truncate failed:', error);
      }
    },

    async executeDropEntity() {
      const { keyspace, entity, entityType } = this.modalData;
      bootstrap.Modal.getInstance(document.getElementById('drop_entity_modal')).hide();

      try {
        await this.fetchResponse(`/api/${entityType}/${keyspace}/${entity}/drop`, { method: 'POST' });
        await this.loadSchema();
        this.selected = { keyspace, entity: null, entityType: null };
        this.entityData = null;
      } catch (error) {
        console.error('Drop entity failed:', error);
      }
    },

    async executeDropKeyspace() {
      const { keyspace } = this.modalData;
      bootstrap.Modal.getInstance(document.getElementById('drop_keyspace_modal')).hide();

      try {
        await this.fetchResponse(`/api/keyspace/${keyspace}/drop`, { method: 'POST' });
        await this.loadSchema();
        this.selected = { keyspace: null, entity: null, entityType: null };
        this.entityData = null;
      } catch (error) {
        console.error('Drop keyspace failed:', error);
      }
    },

    goHome() {
      this.selected = { keyspace: null, entity: null, entityType: null };
      this.entityData = null;
      this.resetPagination();
      window.history.pushState({}, '', '/');
    },

    init() {
      this.loadSchema();
      this.restoreFromURL();

      window.addEventListener('popstate', (event) => {
        if (event.state?.keyspace && event.state?.entity && event.state?.entityType) {
          this.selected = { 
            keyspace: event.state.keyspace, 
            entity: event.state.entity, 
            entityType: event.state.entityType 
          };
          this.loadEntity(event.state.keyspace, event.state.entity, event.state.entityType);
        }
      });
    }
  }
}

</script>